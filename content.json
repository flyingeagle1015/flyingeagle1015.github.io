[{"title":"C代码不在一行多次修改一个变量","date":"2019-03-04T09:52:51.000Z","path":"2019/03/04/c-error-mutliple-modify-one-variable/","text":"不要在同一行代码对同一变量做多次修改源于对大神项目代码学习中遇到得问题，经简化复现方便说明。示例：1234567891011121314151617181920212223242526272829#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;typedef struct &#123; char *buf; int top;&#125;context_t;static int faaa(context_t *c , int o)&#123; c-&gt;top += o; return 6;&#125;int main()&#123; context_t c; memset(&amp;c, 0, sizeof(c)); c.top -= 32 - faaa(&amp;c, 32); printf(\"top:%d, should be 6\\n\", c.top); return EXIT_SUCCESS;&#125;[test@test tmp]$ gcc -g -o test a.c[test@test tmp]$ ./test top:-26, should be 6 代码行中c.top -= 32 - faaa(&amp;c, 32);对c.top做了两次修改：第一次为faaa中的修改第二次为自减操作 为什么会这样呢？马上为您揭晓！123456789101112131415161718192021222324252627282930(gdb) disassemble mainDump of assembler code for function main: 0x00000000004005a2 &lt;+0&gt;: push %rbp 0x00000000004005a3 &lt;+1&gt;: mov %rsp,%rbp 0x00000000004005a6 &lt;+4&gt;: push %rbx 0x00000000004005a7 &lt;+5&gt;: sub $0x18,%rsp 0x00000000004005ab &lt;+9&gt;: lea -0x20(%rbp),%rax 0x00000000004005af &lt;+13&gt;: mov $0x10,%edx 0x00000000004005b4 &lt;+18&gt;: mov $0x0,%esi 0x00000000004005b9 &lt;+23&gt;: mov %rax,%rdi 0x00000000004005bc &lt;+26&gt;: callq 0x400460 &lt;memset@plt&gt; // 对应memset(&amp;c, 0, sizeof(c)); 0x00000000004005c1 &lt;+31&gt;: mov -0x18(%rbp),%ebx // 将c-&gt;top放到寄存器ebx 0x00000000004005c4 &lt;+34&gt;: lea -0x20(%rbp),%rax // 将c地址放到寄存器rax 0x00000000004005c8 &lt;+38&gt;: mov $0x20,%esi // 将20放到寄存器esi, 作为faaa的第二个参数 0x00000000004005cd &lt;+43&gt;: mov %rax,%rdi // rdi作为faaa的第一个参数 0x00000000004005d0 &lt;+46&gt;: callq 0x40057d &lt;faaa&gt; // 调用函数faaa 0x00000000004005d5 &lt;+51&gt;: sub $0x20,%eax // faaa返回值(返回值放eax寄存器) - 32, 这里编译器做了调整a - (b - c) =&gt; a + (c - b) 0x00000000004005d8 &lt;+54&gt;: add %ebx,%eax // 加上“缓存”中的c-&gt;top 0x00000000004005da &lt;+56&gt;: mov %eax,-0x18(%rbp) 0x00000000004005dd &lt;+59&gt;: mov -0x18(%rbp),%eax 0x00000000004005e0 &lt;+62&gt;: mov %eax,%esi 0x00000000004005e2 &lt;+64&gt;: mov $0x400690,%edi 0x00000000004005e7 &lt;+69&gt;: mov $0x0,%eax 0x00000000004005ec &lt;+74&gt;: callq 0x400450 &lt;printf@plt&gt; 0x00000000004005f1 &lt;+79&gt;: mov $0x0,%eax 0x00000000004005f6 &lt;+84&gt;: add $0x18,%rsp 0x00000000004005fa &lt;+88&gt;: pop %rbx 0x00000000004005fb &lt;+89&gt;: pop %rbp 0x00000000004005fc &lt;+90&gt;: retq End of assembler dump. 重点来了, 加上的是缓存的c-&gt;top。解决方案： 将行c.top -= 32 - faaa(&amp;c, 32);拆为两行:12int n = faaa(&amp;c, 32);c.top -= (32 - n);","tags":[{"name":"c","slug":"c","permalink":"https://flyingeagle1015.github.io/tags/c/"}]},{"title":"mysql客户端内存泄漏","date":"2019-02-26T06:58:57.000Z","path":"2019/02/26/mysql_cli_memory_leak/","text":"最近在用Valgrind检查一个库代码, 发现MYSQL的泄漏. 简化MySQL操作代码并测试得到了同样的泄漏.码：1234567891011121314#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;mysql/mysql.h&gt;int main()&#123; MYSQL *MYSQLIns; MYSQLIns = mysql_init(NULL); mysql_real_connect(MYSQLIns, \"localhost\", \"test\", \"123456\", \"test\", 0, NULL, 0); mysql_close(MYSQLIns); return EXIT_SUCCESS;&#125; 编译： gcc -g -L/usr/lib64/mysql -lmysqlclient mysql_mem_test.c -o mysql_mem_testValgrind输出：1234567891011121314151617181920212223242526272829303132333435363738394041valgrind --leak-check=full ./mysql_mem_test==26126== Memcheck, a memory error detector==26126== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.==26126== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info==26126== Command: ./mysql_mem_test==26126== ==26126== ==26126== HEAP SUMMARY:==26126== in use at exit: 8,408 bytes in 4 blocks==26126== total heap usage: 77 allocs, 73 frees, 68,596 bytes allocated==26126== ==26126== 56 bytes in 1 blocks are possibly lost in loss record 1 of 4==26126== at 0x4C29E83: malloc (vg_replace_malloc.c:299)==26126== by 0x4E999E7: my_raw_malloc (my_malloc.c:191)==26126== by 0x4E999E7: my_malloc (my_malloc.c:54)==26126== by 0x4E98A1C: my_error_register (my_error.c:310)==26126== by 0x4E5CC24: mysql_server_init (libmysql.c:116)==26126== by 0x4E655B6: mysql_init (client.c:2460)==26126== by 0x4006CE: main (a.c:9)==26126== ==26126== 176 bytes in 1 blocks are possibly lost in loss record 2 of 4==26126== at 0x4C29E83: malloc (vg_replace_malloc.c:299)==26126== by 0x4E999E7: my_raw_malloc (my_malloc.c:191)==26126== by 0x4E999E7: my_malloc (my_malloc.c:54)==26126== by 0x4E97B8A: init_alloc_root (my_alloc.c:77)==26126== by 0x4E6F01B: mysql_client_plugin_init (client_plugin.c:342)==26126== by 0x4E5CC2B: mysql_server_init (libmysql.c:117)==26126== by 0x4E655B6: mysql_init (client.c:2460)==26126== by 0x4006CE: main (a.c:9)==26126== ==26126== LEAK SUMMARY:==26126== definitely lost: 0 bytes in 0 blocks==26126== indirectly lost: 0 bytes in 0 blocks==26126== possibly lost: 232 bytes in 2 blocks==26126== still reachable: 8,176 bytes in 2 blocks==26126== suppressed: 0 bytes in 0 blocks==26126== Reachable blocks (those to which a pointer was found) are not shown.==26126== To see them, rerun with: --leak-check=full --show-leak-kinds=all==26126== ==26126== For counts of detected and suppressed errors, rerun with: -v==26126== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0) 查阅MySQL C API了解到:在非多线程环境中， mysql_init()根据需要自动调用mysql_library_init()。但是mysql_library_init()不是线程安全的，因此在多线程环境应该在mysql_init()且产生任何线程之前调用mysql_library_init()，或者使用互斥锁来保护mysql_library_init()。这应该在任何其他客户端库调用之前完成。mysql_close()仅释放mysql_init()或mysql_connect()创建的连接，而不会释放mysql_library_init()分配的内存，需要调用mysql_library_end()执行一些内存清理.","tags":[{"name":"mysql","slug":"mysql","permalink":"https://flyingeagle1015.github.io/tags/mysql/"},{"name":"c","slug":"c","permalink":"https://flyingeagle1015.github.io/tags/c/"}]},{"title":"ssh broken pipe","date":"2019-02-13T07:38:44.000Z","path":"2019/02/13/ssh-brokenpipe/","text":"ProblemI use Manjaro Linux at my workplace in a virtual machine hosted by VMWare Workstation. Today I am experiencing issues when I try to connect to servers via ssh.Every time I try to connect, SSH fails with12$ ssh -T git@github.compacket_write_wait: Connection to xxx port 22: Broken pipe Solutionadded “IPQoS throughput” to my ssh_config and now I can connect to all hosts again!1echo \"IPQoS throughput\" | sudo tee -a /etc/ssh/ssh_config // -a 是追加的意思，等同于 &gt;&gt;","tags":[{"name":"ssh","slug":"ssh","permalink":"https://flyingeagle1015.github.io/tags/ssh/"}]},{"title":"python deepcopy","date":"2019-02-13T06:57:04.000Z","path":"2019/02/13/python-deepcopy/","text":"先说结论 对于简单的object用shallow copy和deep copy没有区别: 1234567891011121314151617&gt;&gt;&gt; import copy&gt;&gt;&gt; a = [1, 2, 3, 4]&gt;&gt;&gt; b = copy.copy(a)&gt;&gt;&gt; c = copy.deepcopy(a)&gt;&gt;&gt; id(a)139626388915464&gt;&gt;&gt; id(b)139626389057352&gt;&gt;&gt; id(c)139626389086280&gt;&gt;&gt; a[1] = 11&gt;&gt;&gt; a[1, 11, 3, 4]&gt;&gt;&gt; b[1, 2, 3, 4]&gt;&gt;&gt; c[1, 2, 3, 4] 对于复杂的object如list中套着list的情况, shallow copy时子list并未从原object真的独立出来 12345678910111213141516171819202122232425262728&gt;&gt;&gt; import copy&gt;&gt;&gt; a = [1, 2, 3, 4, [11, 22, 33]]&gt;&gt;&gt; id(a[4])139626388917384&gt;&gt;&gt; id(a)139626389086408&gt;&gt;&gt; &gt;&gt;&gt; b = copy.copy(a)&gt;&gt;&gt; c = copy.deepcopy(a)&gt;&gt;&gt; &gt;&gt;&gt; id(b)139626388915464&gt;&gt;&gt; id(b[4])139626388917384 # b[4]和a[4]引用同一个对象&gt;&gt;&gt; id(c)139626389057352&gt;&gt;&gt; id(c[4])139626389086472&gt;&gt;&gt; &gt;&gt;&gt; &gt;&gt;&gt; a[4][0]=111&gt;&gt;&gt; a[1, 2, 3, 4, [111, 22, 33]]&gt;&gt;&gt; b[1, 2, 3, 4, [111, 22, 33]]&gt;&gt;&gt; c[1, 2, 3, 4, [11, 22, 33]]&gt;&gt;&gt;","tags":[{"name":"python","slug":"python","permalink":"https://flyingeagle1015.github.io/tags/python/"}]},{"title":"ssh远程服务器文件修改","date":"2017-08-12T14:11:25.000Z","path":"2017/08/12/ssh_remotefile/","text":"在工作中时常需要修改远程服务器上的文件，直接用ssh登录远程服务器进行修改是最简单直接的,但比如要临时修改服务器上的代码（不提倡这么做，这里只是举例）做调试之类的，需要语法高亮难道还在服务器上配置一番???在本地配置好的环境进行修改当然是最方便的了，那如何在本地修改远程服务器上的代码呢？常用的有这几个： 如果服务器有配置Samba, 采用磁盘映射的方式 如果文件少，直接用vim远程编辑, 命令：vim scp://hostname//path/to/file 本地安装sshfs, 用sshfs映射到本地进行编辑挂载: sshfs username@serverip:serverpath localpath // 如果配置ssh key可以实现自动化挂载卸载: fusermount -u mountpath 本地修改，采用rsync同步到远程服务器","tags":[{"name":"ssh","slug":"ssh","permalink":"https://flyingeagle1015.github.io/tags/ssh/"}]},{"title":"pacman的使用","date":"2017-06-27T06:00:45.000Z","path":"2017/06/27/pacman_usage/","text":"Pacman 是一个命令行工具，这意味着当你执行下面的命令时，必须在终端或控制台中进行。 1、更新系统在 Arch Linux 系列系统中，使用一条命令即可对整个系统进行更新：1pacman -Syu 如果你已经使用 pacman -Sy 将本地的包数据库与远程的仓库进行了同步，也可以只执行：1pacman -Su 2、安装包1234pacman -S 包名 例如，执行 pacman -S firefox 将安装 Firefox。你也可以同时安装多个包，只需以空格分隔包名即可。pacman -Sy 包名 与上面命令不同的是，该命令将在同步包数据库后再执行安装。pacman -Sv 包名 在显示一些操作信息后执行安装。pacman -U 安装本地包，其扩展名为 pkg.tar.gz。 3、删除包123pacman -R 包名 该命令将只删除包，不包含该包的依赖。pacman -Rs 包名 在删除包的同时，也将删除其依赖。pacman -Rd 包名 在删除包时不检查依赖。 4、搜索包123pacman -Ss 关键字 这将搜索含关键字的包。pacman -Qi 包名 查看有关包的信息。pacman -Ql 包名 列出该包的文件。 5、其他用法 pacman -Sw 包名 只下载包，不安装。 pacman -Sc Pacman 下载的包文件位于 /var/cache/pacman/pkg/ 目录。该命令将清理未安装的包文件。 pacman -Scc 清理所有的缓存文件。","tags":[{"name":"blog","slug":"blog","permalink":"https://flyingeagle1015.github.io/tags/blog/"}]},{"title":"ThinkPHP3.2.3动态包含文件解决方案","date":"2017-06-23T03:36:46.000Z","path":"2017/06/23/thinkphp3-2-3-dynamically-include-templatefile/","text":"老手莫喷哦，我是PHP小菜！使用场景：用户选择需要的页面，动态生成选项卡TAB页。预想代码实现如下：123456789&lt;!-- 其他模板代码 --&gt;&lt;div class=\"tabbable\"&gt; &lt;!-- nav-tabs 相关代码 --&gt; &lt;div class=\"tab-content\"&gt; &lt;foreach name=\"tabfiles\" item=\"ff\"&gt; &lt;include file=\"$ff\" /&gt; &lt;!-- ThinkPHP不支持，这里无法加载文件 --&gt; &lt;/foreach&gt; &lt;/div&gt;&lt;/div&gt; 然而ThinkPHP3.2.3的include标签不支持动态解析。首先想到的是纯php实现文件内容读取，实现代码如下：123456789&lt;!-- 其他模板代码 --&gt;&lt;div class=\"tabbable\"&gt; &lt;!-- nav-tabs 相关代码 --&gt; &lt;div class=\"tab-content\"&gt; &lt;foreach name=\"tabfiles_content\" item=\"ff\"&gt; &lt;!-- tabfiles_content是文件内容的数组 --&gt; $ff &lt;!-- 直接输出文件内容 --&gt; &lt;/foreach&gt; &lt;/div&gt;&lt;/div&gt; 另一种方法类似，只是把文件读取放在模板中，代码如下：123456789&lt;!-- 其他模板代码 --&gt;&lt;div class=\"tabbable\"&gt; &lt;!-- nav-tabs 相关代码 --&gt; &lt;div class=\"tab-content\"&gt; &lt;foreach name=\"tabfiles\" item=\"ff\"&gt; &lt;?php include_once($ff); ?&gt; &lt;!-- PHP 读取文件内容 --&gt; &lt;/foreach&gt; &lt;/div&gt;&lt;/div&gt; 忍不住激动的心情，在浏览器里刷一下，页面真的出来了耶，然而细看一下发现PHP相关变量没有解析，显示也有问题~~~经过查阅ThinkPHP的模板解析代码ThinkPHP/Library/Think/Template.class.php代码，终于感到了上天发现了它的秘密，果断修改显示模板的实现：12//$this-&gt;display('mytabpage');修改为$this-&gt;show($this-&gt;fetch('mytabpage')); 哇哦，漂亮的页面终于出来了！！！","tags":[{"name":"php","slug":"php","permalink":"https://flyingeagle1015.github.io/tags/php/"},{"name":"thinkphp","slug":"thinkphp","permalink":"https://flyingeagle1015.github.io/tags/thinkphp/"}]},{"title":"markdown语法","date":"2017-03-30T06:19:15.000Z","path":"2017/03/30/markdown-syntax/","text":"Markdown Syntax ReferenceFrom http://daringfireball.net/projects/markdown/ Markdown is a text-to-HTML conversion tool for web writers. Markdown allowsyou to write using an easy-to-read, easy-to-write plain text format, thenconvert it to structurally valid XHTML (or HTML). Dataset summaries and discussions on data.world use the Markdown format. Thismeans that users can create beautiful documentation with simple markup that’seasy to write and read. This document will show you how to take advantage of Markdown to format yoursummary and discussion posts. Phrase Emphasis12*italic* **bold**_italic_ __bold__ italic bold LinksInline:1An [example](http://url.com/ \"Title\") An example Reference style labels (titles are optional): 1234An [example][id]. Then, anywhereelse in the doc, define the link: [id]: http://example.com/ \"Title\" ImagesInline (title is optional):1![alt text](/path/img.jpg \"Title\") Reference style:123![alt text][id] [id]: /url/to/img.jpg \"Title\" HeadersThe following formats can all be used interchangeably for headers.12345678910111213Header 1========Header 2--------# Header 1 ### Header 2 ### Header 1## Header 2 ListsOrdered, without paragraphs:121. Foo2. Bar Foo Bar Unordered, with paragraphs:123* A list item. With multiple paragraphs.* Bar A list item.With multiple paragraphs. Bar You can nest them:12345678* An unordered list item * A nested unordered list item* Another list item 1. The first nested ordered list item 2. A second nested ordered list item * A nested unordered list 3. This is the last nested ordered list item* The last unordered list item An unordered list item A nested unordered list item Another list item The first nested ordered list item A second nested ordered list item A nested unordered list This is the last nested ordered list item The last unordered list item Blockquotes123456&gt; Email-style angle brackets&gt; are used for blockquotes.&gt; &gt; And, they can be nested.&gt; &gt;&gt; * You can quote a list.&gt; * Etc. Email-style angle bracketsare used for blockquotes. And, they can be nested. You can quote a list. Etc. Code Spans12`&lt;code&gt;` spans are delimitedby backticks. 12You can include literal backtickslike `` `this` ``. Pre-formatted Code BlocksIndent every line of a code block by at least 4 spaces or 1 tab, and use acolon at the end of the preceding paragraph. 1234This is a normal paragraph: This is a preformatted code block. 1234Preceded by a space, the colon disappears. : This is a preformatted code block. Wrapping code in three back-ticks will also format code blocks : 1Code goes here Horizontal RulesThree or more dashes or asterisks:123---* * *- - - - Manual Line BreaksEnd a line with two or more spaces:12Roses are red,••Violets are blue. (where • is a space) Video/Prezi Embeds(data.world dataset summaries only) Youtube123456789@[youtube](dQw4w9WgXcQ)@[youtube](http://www.youtube.com/embed/dQw4w9WgXcQ)@[youtube](https://www.youtube.com/watch?v=dQw4w9WgXcQ&amp;feature=feedrec_centerforopenscience_index)@[youtube](http://www.youtube.com/user/IngridMichaelsonVEVO#p/a/u/1/QdK8U-VIH_o)@[youtube](http://www.youtube.com/v/dQw4w9WgXcQ?fs=1&amp;amp;hl=en_US&amp;amp;rel=0)@[youtube](http://www.youtube.com/watch?v=dQw4w9WgXcQ#t=0m10s)@[youtube](http://www.youtube.com/embed/dQw4w9WgXcQ?rel=0)@[youtube](http://www.youtube.com/watch?v=dQw4w9WgXcQ)@[youtube](http://youtu.be/dQw4w9WgXcQ) Vimeo123@[vimeo](19706846)@[vimeo](https://vimeo.com/19706846)@[vimeo](https://player.vimeo.com/video/19706846) Prezi1234@[prezi](1kkxdtlp4241)@[prezi](https://prezi.com/1kkxdtlp4241/valentines-day/)@[prezi](https://prezi.com/e3g83t83nw03/destination-prezi-template/)@[prezi](https://prezi.com/prg6t46qgzik/anatomy-of-a-social-powered-customer-service-win/) Math Formulas (MathJax)(data.world dataset summaries only) 123When $a \\ne 0$, there are two solutions to \\\\(ax^2 + bx + c = 0\\\\) and they are$$x = &#123;-b \\pm \\sqrt&#123;b^2-4ac&#125; \\over 2a&#125;.$$ See MathJax Homepage for more information.","tags":[{"name":"markdown","slug":"markdown","permalink":"https://flyingeagle1015.github.io/tags/markdown/"}]}]